%table.table.table-sm.table-striped
  %thead
    %tr
      %th Date
      %th Description
      %th Value
      %th Statement date
      %th Source
      %th Sub-category
      %th
  %tbody
    - expenses.each do |expense|
      %tr
        %td= expense.date.strftime("%Y-%m-%d")
        %td
          = expense.description
          - if expense.comment && expense.comment != ""
            %a{"data-bs-toggle" => "tooltip", "data-bs-title" => "#{expense.comment}"}
              %svg.bi.pe-none.me-2{ :width => "16", :height => "16", "aria-hidden" => "true" }
                %use{ "xlink:href" => "#info" }
        %td{ :class => "#{p 'text-decoration-line-through fw-lighter' if expense.ignore}" }
          = format("%.2f", expense.value)
        %td= "#{expense.statement.year}-#{"%02d" % expense.statement.month}"
        %td
          %a{"data-bs-toggle" => "tooltip", "data-bs-title" => "#{expense.statement.source.name}"}
            %svg.bi.pe-none.me-2{ :width => "16", :height => "16", "aria-hidden" => "true" }
              %use{ "xlink:href" => "#info" }
        %td= expense.subcategory.name
        %td
          %button.btn.btn-sm{ :type => "button", "data-bs-toggle" => "modal", "data-bs-target" => "#editExpenseModal", "onclick" => "render_form(#{expense.id})" }
            %a{"data-bs-toggle" => "tooltip", "data-bs-title" => "Edit"}
              %svg.bi.pe-none.me-2{ :width => "16", :height => "16", "aria-hidden" => "true" }
                %use{ "xlink:href" => "#edit" }

.modal.fade#editExpenseModal{ :tabindex => "-1", "aria-labelledby" => "editExpenseModalLabel", "aria-hidden" => "true", "data-controller" => "expenses"}
  .modal-dialog
    .modal-content
      .modal-header
        Edit expense
      .modal-body#formPlaceholder
        
      .modal-footer
        %button.btn{ :type => "button", "data-bs-dismiss" => "modal" }
          Close
        %button.btn{ :type => "button", :onclick => "send_form()"} 
          Save changes

%script{:type => "text/javascript"}
  function render_form(id) {
  fetch("/expenses/renderform/" + id).then(response => response.text()).then(data => document.getElementById('formPlaceholder').innerHTML = data);
  }
  function send_form() {
  csrf = document.querySelector('meta[name=csrf-token]').content;
  console.log(csrf);
  f = document.getElementsByTagName("form")[0];
  data = new URLSearchParams();
  for (const pair of new FormData(f)) {
  data.append(pair[0], pair[1]);
  }
  fetch(f.action + ".json", {
  method: 'post',
  body: data,
  headers: {"X-CSRF-Token": csrf},
  }).then(response => console.log(response)).then(location.reload());
  }